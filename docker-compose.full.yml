# Full Stack: CLI Proxy API + LibreChat
#
# Usage:
#   docker compose -f docker-compose.full.yml up -d
#
# This starts:
#   - CLIProxyAPI on port 8317
#   - LibreChat on port 3080
#   - MongoDB + Meilisearch (for LibreChat)
#
# Required: Set API_KEY environment variable or in .env file

services:
  # CLI Proxy API - Main proxy server
  cli-proxy-api:
    image: ${CLI_PROXY_IMAGE:-cli-proxy-api:latest}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-none}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    container_name: cli-proxy-api
    restart: always
    ports:
      - "${EXTERNAL_PORT:-8317}:8317"
    volumes:
      - ./auths:/CLIProxyAPI/auths
      - ./logs:/CLIProxyAPI/logs
    environment:
      - API_KEY=${API_KEY:-}
      - PORT=8317
      - SERVER_HOST=
      - DEBUG=${DEBUG:-false}
      - MANAGEMENT_PASSWORD=${MANAGEMENT_PASSWORD:-}
      - MANAGEMENT_ALLOW_REMOTE=${MANAGEMENT_ALLOW_REMOTE:-true}
      - REQUEST_RETRY=${REQUEST_RETRY:-3}
      - MAX_RETRY_INTERVAL=${MAX_RETRY_INTERVAL:-30}
      - ROUTING_STRATEGY=${ROUTING_STRATEGY:-round-robin}
      - LOGGING_TO_FILE=${LOGGING_TO_FILE:-false}
      - USAGE_STATS=${USAGE_STATS:-false}
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
      - TZ=${TZ:-UTC}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8317/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # LibreChat - Chat UI
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "${LIBRECHAT_PORT:-3080}:3080"
    depends_on:
      cli-proxy-api:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      - HOST=0.0.0.0
      - PORT=3080
      - NODE_ENV=production
      - MONGO_URI=mongodb://mongodb:27017/LibreChat

      # Security keys - generate your own for production
      - CREDS_KEY=${CREDS_KEY:-generated_cred_here}
      - CREDS_IV=${CREDS_IV:-generated_cred_here}
      - JWT_SECRET=${JWT_SECRET:-generated_cred_here}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-generated_cred_here}

      # Search
      - SEARCH=${SEARCH:-true}
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-generated_cred_here}

      # Registration
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION:-true}
      - ALLOW_SOCIAL_LOGIN=false
      - ALLOW_SOCIAL_REGISTRATION=false

      - NO_INDEX=${NO_INDEX:-true}
      - TZ=${TZ:-UTC}
    volumes:
      # librechat.yaml: mount from repo or Coolify persistent storage
      # Coolify example source: /data/coolify/applications/.../librechat/librechat.yaml
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./librechat/images:/app/client/public/images
      - ./librechat/logs:/app/api/logs

  # MongoDB - LibreChat database
  mongodb:
    image: mongo:8.0.17
    container_name: librechat-mongodb
    restart: always
    command: mongod --noauth
    volumes:
      - ./librechat/data-node:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Meilisearch - LibreChat search
  meilisearch:
    image: getmeili/meilisearch:v1.12.3
    container_name: librechat-meilisearch
    restart: always
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-generated_cred_here}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./librechat/meili_data_v1.12:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
