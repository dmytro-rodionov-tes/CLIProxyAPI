# LibreChat Integration for CLI Proxy API
#
# This compose file adds LibreChat as an optional frontend for CLIProxyAPI.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.librechat.yml up -d
#
# This will start:
#   - CLIProxyAPI (API proxy)
#   - LibreChat (Chat UI on port 3080)
#   - MongoDB (LibreChat database)
#   - Meilisearch (LibreChat search)
#
# Access LibreChat at: http://localhost:3080

services:
  # LibreChat - Full-featured AI chat interface
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "${LIBRECHAT_PORT:-3080}:3080"
    depends_on:
      cli-proxy-api:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      - HOST=0.0.0.0
      - PORT=3080
      - MONGO_URI=mongodb://mongodb:27017/LibreChat

      # Security keys - generate your own for production:
      # openssl rand -hex 32
      - CREDS_KEY=${CREDS_KEY:-f34be427ebb29de8d88c107a71546019685ed8b241d8f2ed00c3df97ad2566f0}
      - CREDS_IV=${CREDS_IV:-e2341419ec3dd3d19b13a1a87fafcbfb}
      - JWT_SECRET=${JWT_SECRET:-16f8c0ef4a5d391b26034086c628469d3f9f497f08163ab9b40137092f2909ef}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-eaa5191f2914e30b9387fd84e254e4ba6fc51b4654968a9b0803b456a54b8418}

      # Search
      - SEARCH=${SEARCH:-true}
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-DrhYf7zENyR6AlUCKmnz0eYASOQdl6zxH7s7MKFSfFCt}

      # Registration
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION:-true}
      - ALLOW_SOCIAL_LOGIN=false
      - ALLOW_SOCIAL_REGISTRATION=false

      - NO_INDEX=${NO_INDEX:-true}
      - TZ=${TZ:-UTC}
    volumes:
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./librechat/images:/app/client/public/images
      - ./librechat/logs:/app/api/logs

  # MongoDB - Required for LibreChat
  mongodb:
    image: mongo:8.0.17
    container_name: librechat-mongodb
    restart: always
    command: mongod --noauth
    volumes:
      - ./librechat/data-node:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Meilisearch - Search for LibreChat
  meilisearch:
    image: getmeili/meilisearch:v1.12.3
    container_name: librechat-meilisearch
    restart: always
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-DrhYf7zENyR6AlUCKmnz0eYASOQdl6zxH7s7MKFSfFCt}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./librechat/meili_data_v1.12:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
